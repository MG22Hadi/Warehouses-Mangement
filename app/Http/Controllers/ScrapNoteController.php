<?php

namespace App\Http\Controllers;

use App\Http\Controllers\Controller;
use App\Models\ExitNote;
use App\Models\Location;
use App\Models\Product;
use App\Models\ProductLocation;
use App\Models\ProductMovement;
use App\Models\ScrapNote;
use App\Models\ScrappedMaterial;
use App\Models\Stock;
use App\Models\WarehouseKeeper;
use App\Services\NotificationService;
use App\Traits\ApiResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Validator;
use App\Services\InventoryService;

class ScrapNoteController extends Controller
{
    //
    use ApiResponse;

    protected $notificationService;

    public function __construct(NotificationService $notificationService)
    {
        $this->notificationService = $notificationService;
    }

    // ุฅุธูุงุฑ ูู ุงููุฐูุฑุงุช
    public function index()
    {
        try {
            $notes = ScrapNote::with(['materials.product', 'createdBy', 'approvedBy'])
                ->withCount('materials as materials_count')
                ->orderBy('created_at', 'desc')
                ->get();

            return $this->successResponse($notes, 'ุชู ุฌูุจ ุงููุฐูุฑุงุช ูุน ุนุฏุฏ ุงูุฃุตูุงู ุจูุฌุงุญ');
        } catch (\Exception $e) {
            return $this->handleExceptionResponse($e);
        }
    }



    public function store(Request $request)
    {
        $user = Auth::user();

        $validator = Validator::make($request->all(), [
            'date' => 'required|date',
            'reason' => 'nullable|string|max:1000',
            'notes' => 'nullable|string|max:1000',
            'materials' => 'required|array|min:1',
            'materials.*.product_id' => 'required|exists:products,id',
            'materials.*.quantity' => 'required|numeric|min:0.01',
            'materials.*.notes' => 'nullable|string|max:500',
        ]);

        if ($validator->fails()) {
            return $this->validationErrorResponse($validator);
        }

        try {
            $scrapNote = null;
            $locationMessages = [];

            DB::transaction(function () use ($request, &$scrapNote, &$locationMessages) {
                // ุฅูุดุงุก ูุฐูุฑุฉ ุงูุชูู
                $scrapNote = ScrapNote::create([
                    'created_by' => $request->user()->id,
                    'approved_by' => null,
                    'serial_number' => $this->generateSerialNumber(),
                    'reason' => $request->reason,
                    'date' => $request->date,
                    'notes' => $request->notes,
                ]);

                // ุฅุถุงูุฉ ุงูููุงุฏ ุงูุชุงููุฉ ููุท
                foreach ($request->materials as $material) {
                    $product = Product::findOrFail($material['product_id']);
                    $quantity = $material['quantity'];

                    ScrappedMaterial::create([
                        'scrap_note_id' => $scrapNote->id,
                        'product_id' => $product->id,
                        'quantity' => $quantity,
                        'notes' => $material['notes'] ?? null,
                    ]);

                    // ููุท ุฑุณุงูุฉ ุชูุถูุญูุฉ (ุจุฏูู ุชุฎุฒูู location_id)
                    $locationMessages[] = "ุชู ุฅุชูุงู {$quantity} {$product->unit} ูู ุงูููุชุฌ '{$product->name}'.";
                }
            });

            try {
                //  ุฅูุฌุงุฏ ุงููุฏูุฑ ุนุจุฑ ุงูุนูุงูุงุช: ุฃููู ุงููุณุชูุฏุน -> ูุณุชูุฏุน -> ูุณู -> ูุฏูุฑ
                $warehouseKeeper = WarehouseKeeper::where('id', $user->id)->firstOrFail();

                $warehouseId = $request->warehouse_id ?? null;

                $warehouse = $warehouseKeeper->warehouse()
                    ->when($warehouseId, function ($q) use ($warehouseId) {
                        $q->where('id', $warehouseId);
                    })
                    ->first();
                if (!$warehouse) {
                    throw new \Exception('ูุง ููุฌุฏ ูุณุชูุฏุน ูุฑุชุจุท ุจุฃููู ุงููุณุชูุฏุน.');
                }

                $department = $warehouse->department;
                if (!$department) {
                    throw new \Exception('ูุง ููุฌุฏ ูุณู ูุฑุชุจุท ุจุงููุณุชูุฏุน.');
                }

                $manager = $department->manager;
                if (!$manager) {
                    throw new \Exception('ูุง ููุฌุฏ ูุฏูุฑ ูุฑุชุจุท ุจุงููุณู.');
                }

            } catch (\Exception $e) {
                return $this->errorResponse(
                    'ูุดู ูู ุชุญุฏูุฏ ูุฏูุฑ ุงููุณู ุงููุฑุชุจุท ุจุฃููู ุงููุณุชูุฏุน: ' . $e->getMessage(),
                    404,
                    [],
                    'MANAGER_NOT_FOUND'
                );
            }


            // ๐ ุฅุดุนุงุฑ ุงููุฏูุฑ
            if ($manager && isset($this->notificationService)) {
                $this->notificationService->notify(
                    $manager,
                    'ุทูุจ ุฅุชูุงู ููุงุฏ ุฌุฏูุฏ',
                    'ููุฌุฏ ุทูุจ ุฅุชูุงู ููุงุฏ ุฌุฏูุฏ ุจุงูุชุธุงุฑ ุงููุฑุงุฌุนุฉ (ุฑูู: ' . $scrapNote->serial_number . ')',
                    'scrap-note',
                    $scrapNote->id
                );
            }

            return $this->successResponse(
                [
                    'scrap_note' => $scrapNote->load('materials'),
                    'location_messages' => $locationMessages,
                ],
                'ุชู ุฅูุดุงุก ูุฐูุฑุฉ ุงูุชูู ุจูุฌุงุญ ูุณูู ูุชู ูุฑุงุฌุนุชูุง ููููุงููุฉ'
            );

        } catch (\Throwable $e) {
            DB::rollBack();
            return $this->errorResponse(
                message: 'ูุดู ูู ุฅูุดุงุก ูุฐูุฑุฉ ุงูุชูู: ' . $e->getMessage(),
                code: 422,
                internalCode: 'SCRAP_NOTE_CREATION_FAILED'
            );
        }
    }


    public function approve(Request $request, $id)
    {
        $user = Auth::user();

        try {
            DB::transaction(function () use ($id, $request, $user) {
                $scrapNote = ScrapNote::with('materials.product')->findOrFail($id);

                if ($scrapNote->status != ScrapNote::STATUS_PENDING) {
                    throw new \Exception('ูุง ูููู ุงูููุงููุฉ ุนูู ูุฐูุฑุฉ ุชูู ุบูุฑ ูุนููุฉ.');
                }

                // ุงูุญููุฉ: ุชูููุฐ ุงูุฎุตููุงุช ูุงูุชุญุฏูุซุงุช ุงููุนููุฉ
                foreach ($scrapNote->materials as $material) {
                    $productId = $material->product_id;

                    // ุงุจุญุซ ุนู ูููุน ููู ุงููููุฉ ุงููุทููุจุฉ
                    $productLocation = ProductLocation::where('product_id', $material->product_id)
                        ->where('quantity', '>=', $material->quantity)
                        ->first();

                    if (!$productLocation) {
                        throw new \Exception("ุงููููุฉ ุงููุทููุจุฉ ({$material->quantity}) ูู ุงูููุชุฌ '{$material->name}' ุบูุฑ ูุชููุฑุฉ ูู ุฃู ูููุน.");
                    }

                    $location = $productLocation->location;

                    // ุฎูุตูู ุงููููููููุฉ
                    $productLocation->decrement('quantity', $material->quantity);
                    $location->decrement('used_capacity_units', $material->quantity);

                    // ุฑุณุงูุฉ ูููุณุชุฎุฏู
                    $locationMessages[] = "ุชู ุฎุตู {$material->quantity} {$material->unit} ูู ุงูููุชุฌ '{$material->name}' ูู ุงููููุน '{$location->name}'.";


                    $quantityToScrap = $material->quantity; // <--- ุงุณุชุฎุฏุงู ุงููููุฉ ุงูุฃุตููุฉ ุงูุชู ุทูุจูุง ุฃููู ุงููุณุชูุฏุน
                    $locationId = $material->location_id;   // <--- ุงุณุชุฎุฏุงู ุงูู location_id ุงููุฎุฒู ุฃุตูุงู

                    // ุฅุฐุง ูุงูุช ุงููููุฉ ุงูุฃุตููุฉ ุตูุฑ ุฃู ุฃููุ ูุง ูููู ุจุฃู ุฎุตู ุฃู ุญุฑูุฉ ููุฐู ุงููุงุฏุฉ
                    if ($quantityToScrap <= 0) {
                        $material->update(['quantity_approved' => 0]);
                        continue;
                    }


                    // ุชุญุฏูุซ ุนูุตุฑ ScrappedMaterial ุจุงููููุฉ ุงูุฃุตููุฉ ูููุงููุฉ ุนูููุง
                    $material->update([
                        'quantity_approved' => $quantityToScrap, // ุงููููุฉ ุงููุนุชูุฏุฉ ูู ููุณูุง ุงููููุฉ ุงููุทููุจุฉ
                    ]);



                    // ุชุญุฏูุซ ุงููุฎุฒูู ุงูุฅุฌูุงูู (Stocks)
                    $stock = Stock::firstOrCreate(
                        ['product_id' => $productId, 'warehouse_id' => $location->warehouse_id],
                        ['quantity' => 0]
                    );

                    $prvQuantity = $stock->quantity;
                    $stock->decrement('quantity', $quantityToScrap);

                    // ุชุณุฌูู ุญุฑูุฉ ุงูููุชุฌ (ProductMovement)
                    ProductMovement::create([
                        'product_id' => $productId,
                        'warehouse_id' => $location->warehouse_id,
                        'type' => 'scrap',
                        'reference_serial' => $scrapNote->serial_number,
                        'prv_quantity' => $prvQuantity,
                        'note_quantity' => $quantityToScrap,
                        'after_quantity' => $stock->quantity,
                        'date' => now(),
                        'reference_type' => 'ScrappedMaterial',
                        'reference_id' => $material->id,
                        'user_id' => $user->id,
                        'notes' => 'ุฅุชูุงู ุงูููุชุฌ ' . $material->product->name . ' ุจูุงุกู ุนูู ููุงููุฉ ูุฐูุฑุฉ ุงูุชูู ' . $scrapNote->serial_number,
                    ]);
                }

                // ุชุญุฏูุซ ุญุงูุฉ ูุฐูุฑุฉ ุงูุชูู
                $scrapNote->update([
                    'status' => ScrapNote::STATUS_APPROVED,
                    'approved_by' => $user->id,
                    'approved_at' => now(),
                ]);

                // ๐ ุฅุดุนุงุฑ ููู warehouseKeeper (ุงูููุดุฆ)
                $creator =$scrapNote->createdBy;
                if ($creator) {
                    $this->notificationService->notify(
                        $creator,
                        'ุงูููุงููุฉ ุนูู ุทูุจ ุฅุชูุงู ููุงุฏ',
                        'ุชูุช ุงูููุงููุฉ ุนูู ุทูุจ ุฅุชูุงู ููุงุฏ ุงูุฎุงุต ุจู (ุฑูู: ' .$scrapNote->serial_number . ').',
                        'scrap-note',
                        $scrapNote->id
                    );
                }

            });

            return $this->successResponse(
                null,'ุชูุช ุงูููุงููุฉ ุนูู ูุฐูุฑุฉ ุงูุชูู ูุชูููุต ุงููููุงุช ุจูุฌุงุญ ูุฅุฑุณุงู ุฅุดุนุงุฑ ูุฃููู ุงููุณุชูุฏุน .'
            );
        } catch (\Throwable $e) { // ุงุณุชุฎุฏุงู Throwable ูุฃุฎุทุงุก ุฃูุณุน
            DB::rollBack();

            // ุชุญูู ุฅุฐุง ูุงู ุงูุชุทุจูู ูู ูุถุน ุงูุชุตุญูุญ (Debug Mode)
            if (config('app.debug')) {
                //  ูู ุจูุฆุฉ ุงูุชุทููุฑ: ุฃุฑุฌุน ุงูุฎุทุฃ ุจุงูุชูุตูู ุงููุงูู
                return response()->json([
                    'success' => false,
                    'message' => 'ุญุฏุซ ุฎุทุฃ: ' . $e->getMessage(),
                    'file' => $e->getFile(), // <-- ููู ุงูุฎุทุฃ
                    'line' => $e->getLine(), // <-- ุณุทุฑ ุงูุฎุทุฃ
                    'trace' => $e->getTraceAsString() // <-- ุชุชุจุน ูุณุงุฑ ุงูุฎุทุฃ (ุงุฎุชูุงุฑู ููู ูููุฏ ุฌุฏุงู)
                ], 500); // 500 ูู ุฑูุฒ ุงูุฎุทุฃ ุงูุฃูุณุจ ููุฎูุงุฏู
            }

            // ูู ุจูุฆุฉ ุงูุฅูุชุงุฌ: ุฃุฑุฌุน ุฑุณุงูุฉ ุนุงูุฉ ูุขููุฉ
            return $this->errorResponse(
                message: 'ูุดู ูู ุงูููุงููุฉ ุนูู ุงููุฐูุฑุฉุ ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน.',
                code: 500, // ุงุณุชุฎุฏู 500 Internal Server Error
                internalCode: 'SCRAP_NOTE_APPROVAL_FAILED'
            );
        }
    }
    public function reject(Request $request, $id)
    {
        $request->validate([
            'rejection_reason' => 'required|string'
        ]);

        try {
            $scrapNote = ScrapNote::findOrFail($id);

            if ($scrapNote->status != ScrapNote::STATUS_PENDING) {
                throw new \Exception("ูุง ูููู ุฑูุถ ุทูุจ ุบูุฑ ูุนูู ");
            }

            $scrapNote->update([
                'status' => ScrapNote::STATUS_REJECTED,
                'rejection_reason' => $request->rejection_reason,
                'approved_by' =>null /*auth()->id()*/,
                'approved_at' => now(),
            ]);

            // ๐ ุฅุดุนุงุฑ ููู warehouseKeeper (ุงูููุดุฆ)
            $creator =$scrapNote->createdBy;
            if ($creator) {
                $this->notificationService->notify(
                    $creator,
                    'ุฑูุถ ุทูุจ ุฅุชูุงู ููุงุฏ',
                    'ุนุฐุฑุงู ุชู ุฑูุถ ุทูุจ ุฅุชูุงู ููุงุฏ ุงูุฎุงุต ุจู (ุฑูู: ' .$scrapNote->serial_number . ').',
                    'scrap-note',
                    $scrapNote->id
                );
            }

            return $this->successMessage( 'ุชู ุฑูุถ ูุฐูุฑุฉ ุงูุชูู ุจูุฌุงุญ');

        } catch (\Exception $e) {
            return $this->errorResponse(
                message: 'ูุดู ูู ุฑูุถ ุงููุฐูุฑุฉ' . $e->getMessage(),
                code: 422,
                internalCode: 'SCRAP_NOTE_CREATION_FAILED'
            );
        }
    }

    //ุฅุธูุงุฑ ูุฐูุฑุฉ ูุญุฏุฏุฉ
    public function show($id)
    {
        try {
            $note = ScrapNote::with([
                'materials.product', // ุชุญููู ุงูููุงุฏ ูุน ูุนูููุงุช ุงูููุชุฌ
                'createdBy:id,name', // ูุนูููุงุช ููุดุฆ ุงููุฐูุฑุฉ
                'approvedBy:id,name' // ูุนูููุงุช ุงูููุงูู (ุฅุฐุง ููุฌูุฏ)
            ])->findOrFail($id);
            return $this->successResponse($note, 'ุชู ุฌูุจ ุงููุฐูุฑุฉ ุจูุฌุงุญ');
        } catch (\Exception $e) {
            return $this->handleExceptionResponse($e, 'ุงููุฐูุฑุฉ ุบูุฑ ููุฌูุฏุฉ');
        }
    }


    private function generateSerialNumber(): string
    {
        $currentYear = date('Y');

        // ุงูุญุตูู ุนูู ุขุฎุฑ ูุฐูุฑุฉ ููุฐู ุงูุณูุฉ
        $lastEntry = ScrapNote::whereYear('created_at', $currentYear)
            ->orderBy('id', 'desc')
            ->first();

        // ุชุญุฏูุฏ ุงูุฃุฑูุงู ุงูุฌุฏูุฏุฉ
        if (!$lastEntry) {
            // ุฃูู ูุฐูุฑุฉ ูู ุงูุณูุฉ
            $folderNumber = 1;
            $noteNumber = 1;
        } else {
            // ูู ุงูุชุฑููุฒ ูู ุงูุณูุฑูุงู ุงูุณุงุจู
            $serial = trim($lastEntry->serial_number, '()');
            list($lastFolderNumber, $lastNoteNumber) = explode('/', $serial);

            $lastFolderNumber = (int)$lastFolderNumber;
            $lastNoteNumber = (int)$lastNoteNumber;

            // ุญุณุงุจ ุงูุฃุฑูุงู ุงูุฌุฏูุฏุฉ
            $noteNumber = $lastNoteNumber + 1;
            $folderNumber = $lastFolderNumber;

            if ($noteNumber % 50 == 1 && $noteNumber > 50) {
                $folderNumber = floor($noteNumber / 50) + 1;
            }
        }

        return "($folderNumber/$noteNumber)";
    }

    protected function generateSerialNumberPM()
    {
        $currentYear = date('Y');

        // ุงูุญุตูู ุนูู ุขุฎุฑ ูุฐูุฑุฉ ููุฐู ุงูุณูุฉ
        $lastEntry = ProductMovement::whereYear('created_at', $currentYear)
            ->orderBy('id', 'desc')
            ->first();

        // ุชุญุฏูุฏ ุงูุฃุฑูุงู ุงูุฌุฏูุฏุฉ
        if (!$lastEntry) {
            // ุฃูู ูุฐูุฑุฉ ูู ุงูุณูุฉ
            $folderNumber = 1;
            $noteNumber = 1;
        } else {
            // ูู ุงูุชุฑููุฒ ูู ุงูุณูุฑูุงู ุงูุณุงุจู
            $serial = trim($lastEntry->reference_serial, '()');
            list($lastFolderNumber, $lastNoteNumber) = explode('/', $serial);

            $lastFolderNumber = (int)$lastFolderNumber;
            $lastNoteNumber = (int)$lastNoteNumber;

            // ุญุณุงุจ ุงูุฃุฑูุงู ุงูุฌุฏูุฏุฉ
            $noteNumber = $lastNoteNumber + 1;
            $folderNumber = $lastFolderNumber;

            if ($noteNumber % 50 == 1 && $noteNumber > 50) {
                $folderNumber = floor($noteNumber / 50) + 1;
            }
        }

        return "($folderNumber/$noteNumber)";
}

}
